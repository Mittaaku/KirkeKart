<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Kirkekart</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" />

  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" defer></script>

  <style>
    :root{
      --font-sans:'Inter',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji';
      --font-serif:'EB Garamond',ui-serif,Georgia,Cambria,'Times New Roman',Times,serif;

      --ink: #212529;
      --muted: rgba(33,37,41,.72);

      --card: #fff;
      --card-border: rgba(0,0,0,.10);
      --shadow: 0 .5rem 1.25rem rgba(0,0,0,.08);

      --amber: #ffc107;
      --amber-ink: #b45309;
      --amber-focus: rgba(255,193,7,.55);

      --radius-lg: 16px;
      --radius-md: 12px;
    }

    body { overscroll-behavior: none; font-family: var(--font-sans); color: var(--ink); }
    .font-sans { font-family: var(--font-sans); }
    .font-serif, .h-serif { font-family: var(--font-serif); }
    .sc { font-variant: small-caps; letter-spacing: .01em; }
    .lead-muted { color: var(--muted); }
    .p-comfy { line-height: 1.62; }

    /* Consistent rounded + shadows */
    .cardish {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    /* Map sizing */
    #map { height: min(62vh, 680px); }
    @media (max-width: 768px) { #map { height: 56vh; } }

    /* Focus visibility */
    :focus-visible {
      outline: 3px solid var(--amber-focus);
      outline-offset: 2px;
      border-radius: 10px;
    }
    .visually-hidden-focusable:focus {
      clip: auto !important;
      clip-path: none !important;
      height: auto !important;
      width: auto !important;
      white-space: normal !important;
      z-index: 10000;
    }

    .icon-badge {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(255, 193, 7, 0.12);
      border: 1px solid rgba(255, 193, 7, 0.25);
      color: var(--amber-ink);
      flex: 0 0 auto;
      margin-top: 2px;
    }

    /* Loading overlay */
    #map.loading-blur { filter: blur(2px) saturate(0.9); }
    #loading {
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      background: rgba(255,255,255,.72);
    }
    .loading-card {
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 .5rem 1.25rem rgba(0,0,0,.10);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
    }
    .loading-text { font-size: .98rem; color: var(--muted); }

    /* Reserve space so notice doesn’t jump layout */
    #notice { min-height: 0; }

    /* Leaflet controls: consistent */
    .leaflet-bar a {
      border-radius: var(--radius-md) !important;
      box-shadow: 0 .25rem .75rem rgba(0,0,0,.10);
      border: 1px solid rgba(0,0,0,.10) !important;
    }
    .leaflet-bar a:focus-visible {
      outline: 3px solid var(--amber-focus);
      outline-offset: 2px;
    }
    .leaflet-control-scale-line {
      border-radius: 10px;
      padding: 2px 6px;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 .25rem .75rem rgba(0,0,0,.08);
    }

    /* Bootstrap accordion polish (consistent corners + no “double borders”) */
    .accordion-item { border: 0; }
    .accordion-button { background: #fff; }
    .accordion-button:not(.collapsed) { background: rgba(255,193,7,.08); color: var(--ink); }
    .accordion-button:focus { box-shadow: none; } /* we use :focus-visible outline */

    /* Alerts match card corners */
    .alert { border-radius: var(--radius-lg); }
  </style>
</head>

<body class="bg-light text-dark">
  <a href="#map" class="visually-hidden-focusable position-absolute m-2 p-2 bg-white border rounded">
    Hopp til kart
  </a>

  <header class="border-bottom bg-white">
    <div class="container-fluid py-4 py-md-5">
      <div class="mx-auto" style="max-width: 1200px;">

        <h1 class="sc mb-2 text-center h-serif"
            style="font-weight: 700; font-size: clamp(1.9rem, 3vw, 2.7rem);">
          Kirkekart – Norge
        </h1>

        <p class="mb-4 text-center mx-auto lead-muted"
           style="max-width: 80ch; font-size: 1.05rem;">
          Et enkelt kart for å hjelpe deg å finne menigheter som driver menighet slik Bibelen sier det skal drives.
        </p>

        <!-- Map -->
        <div class="mb-3">
          <div id="map"
               role="region"
               aria-label="Kart over menigheter i Sør-Norge"
               class="position-relative overflow-hidden cardish">

            <div id="loading"
                 class="position-absolute top-0 start-0 end-0 bottom-0 d-none align-items-center justify-content-center">
              <div class="loading-card d-flex align-items-center gap-3">
                <div class="spinner-border text-secondary" role="status" aria-label="Laster"></div>
                <div class="loading-text">
                  <div class="fw-semibold text-dark">Laster menigheter…</div>
                  <div class="small">Henter data og oppdaterer kartet.</div>
                </div>
              </div>
            </div>
          </div>

          <div id="notice" class="mt-3"></div>
        </div>

        <!-- Kriterier -->
        <div class="accordion mt-4" id="criteriaSection">
          <div class="accordion-item cardish overflow-hidden">
            <h2 class="accordion-header" id="criteriaSectionH">
              <button class="accordion-button collapsed h-serif" type="button"
                      data-bs-toggle="collapse" data-bs-target="#criteriaSectionBody"
                      aria-expanded="false" aria-controls="criteriaSectionBody">
                <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-list-check"></i></span>
                Kriterier
                <span class="ms-auto small text-secondary">Kriteriene for menighetene på kartet</span>
              </button>
            </h2>

            <div id="criteriaSectionBody" class="accordion-collapse collapse"
                 aria-labelledby="criteriaSectionH" data-bs-parent="#criteriaSection">
              <div class="accordion-body">

                <div class="accordion" id="criteriaAccordion">

                  <!-- Protestantisk -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critOneH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critOne"
                              aria-expanded="false" aria-controls="critOne">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-book-bible"></i></span>
                        Protestantisk
                      </button>
                    </h3>
                    <div id="critOne" class="accordion-collapse collapse" aria-labelledby="critOneH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          En protestantisk forankring gir menigheten et fast og felles utgangspunkt: Guds ord, ikke skiftende tradisjoner eller personlige preferanser. Når frelsen forstås som Guds frie gave i Kristus alene, skapes det både trygghet for den enkelte og ydmykhet i fellesskapet, og hele menighetslivet rettes mot Guds ære fremfor menneskelig prestasjon.
                        </p>
                        <div class="small text-secondary fst-italic">Rom 1,16–17 · Ef 2,8–9 · Joh 14,6 · 1 Kor 10,31</div>
                      </div>
                    </div>
                  </div>

                  <!-- Familiesentrert -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critFiveH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critFive"
                              aria-expanded="false" aria-controls="critFive">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-house"></i></span>
                        Familiesentrert
                      </button>
                    </h3>
                    <div id="critFive" class="accordion-collapse collapse" aria-labelledby="critFiveH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          En familiesentrert forståelse styrker både menighet og samfunn ved å bygge nedenfra og opp. Når ekteskap, foreldreskap og generasjoner tas på alvor, skapes stabile rammer for trosoverføring, ansvar og omsorg. Menigheten blir et sted hvor familier støttes i sitt kall, og hvor fellesskapet formes av varige relasjoner.
                        </p>
                        <div class="small text-secondary fst-italic">1 Mos 2,24 · Sal 127 · Ef 6,1–4 · 2 Tim 1,5</div>
                      </div>
                    </div>
                  </div>

                  <!-- Forpliktende medlemskap -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critTwoH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critTwo"
                              aria-expanded="false" aria-controls="critTwo">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-user-group"></i></span>
                        Forpliktende medlemskap
                      </button>
                    </h3>
                    <div id="critTwo" class="accordion-collapse collapse" aria-labelledby="critTwoH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          Forpliktende medlemskap gjør menigheten til et virkelig fellesskap, ikke bare et løst nettverk av enkeltpersoner. Når mennesker binder seg til hverandre i ansvar og nærvær, skapes stabilitet, gjensidig omsorg og rom for å vokse i tro over tid. Menigheten blir da en kropp som faktisk bærer sine lemmer.
                        </p>
                        <div class="small text-secondary fst-italic">Heb 10,24–25 · Apg 2,42</div>
                      </div>
                    </div>
                  </div>

                  <!-- Bibelsk menighetsstruktur -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critThreeH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critThree"
                              aria-expanded="false" aria-controls="critThree">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-sitemap"></i></span>
                        Bibelsk menighetsstruktur
                      </button>
                    </h3>
                    <div id="critThree" class="accordion-collapse collapse" aria-labelledby="critThreeH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          En bibelsk menighetsstruktur beskytter både menigheten og lederne ved å gi klare rammer for ansvar og tjeneste. Når lederskapet består av bibelske kvalifiserte menn, fremfor pragmatiske figurer, fremmes modenhet, kontinuitet og tillit, og menigheten kan ledes med både fasthet og omsorg.
                        </p>
                        <div class="small text-secondary fst-italic">1 Tim 3,1–13 · Tit 1,5–9</div>
                      </div>
                    </div>
                  </div>

                  <!-- Kirkedisiplin -->
                  <div class="accordion-item cardish overflow-hidden mb-0">
                    <h3 class="accordion-header" id="critFourH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critFour"
                              aria-expanded="false" aria-controls="critFour">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-gavel"></i></span>
                        Kirkedisiplin
                      </button>
                    </h3>
                    <div id="critFour" class="accordion-collapse collapse" aria-labelledby="critFourH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          Kirkedisiplin er gitt for å verne både enkeltmennesket og fellesskapet. Når alvorlig synd tas på alvor i kjærlighet og sannhet, tydeliggjøres evangeliets alvor og nåde. Målet er alltid omvendelse og gjenopprettelse, slik at menigheten kan forbli et sunt og troverdig vitnesbyrd.
                        </p>
                        <div class="small text-secondary fst-italic">Matt 18,15–17 · 1 Kor 5</div>
                      </div>
                    </div>
                  </div>

                </div><!-- /criteriaAccordion -->
              </div>
            </div>
          </div>
        </div><!-- /criteriaSection -->

        <!-- Meld inn / foreslå endring -->
        <div class="accordion mt-4" id="submitSection">
          <div class="accordion-item cardish overflow-hidden">
            <h2 class="accordion-header" id="submitSectionH">
              <button class="accordion-button collapsed h-serif" type="button"
                      data-bs-toggle="collapse" data-bs-target="#submitSectionBody"
                      aria-expanded="false" aria-controls="submitSectionBody">
                <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-pen-to-square"></i></span>
                Meld inn menighet eller endring
                <span class="ms-auto small text-secondary">Skjema for innmelding til kartet</span>
              </button>
            </h2>
            <div id="submitSectionBody" class="accordion-collapse collapse"
                 aria-labelledby="submitSectionH" data-bs-parent="#submitSection">
              <div class="accordion-body">
                <p class="mb-3 text-secondary p-comfy">
                  Har du en menighet som bør legges til, eller en opplysning som må korrigeres? Bruk skjemaet under.
                </p>
                <div class="ratio" style="--bs-aspect-ratio: 140%;">
                  <iframe
                    title="Skjema: meld inn menighet eller endring"
                    src="https://docs.google.com/forms/d/e/1FAIpQLSelRxSIeMS6iY4kXhmf5w2dAfrYh3VHGtIoLuKC8VCuqi_XOw/viewform?usp=publish-editor"
                    loading="lazy"
                    style="border:0;"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
              </div>
            </div>
          </div>
        </div><!-- /submitSection -->

      </div><!-- /max-width -->
    </div><!-- /container -->
  </header>

  <main class="py-4"></main>

<script>
  (function () {
    "use strict";

    const CSV_URL = "https://docs.google.com/spreadsheets/d/1iQMv5M8hrapIbvolhIKRRHOcX3yx7CPX8zQogXzwhtec/export?format=csv";

    const SOUTHERN_NORWAY_BOUNDS = [ [57.8, 3.5], [62.6, 13.6] ];
    const SOUTHERN_LOCK_BOUNDS   = [ [57.5, 2.0], [62.9, 14.5] ];

    let CHURCHES = [];
    let map = null;
    let markersLayer = null;

    const $ = (id) => document.getElementById(id);

    function normalizeWebsite(url) {
      const raw = String(url ?? "").trim();
      if (!raw) return "";
      const prefixed = /^https?:\/\//i.test(raw) ? raw : "https://" + raw;
      try {
        const u = new URL(prefixed);
        return (u.protocol === "http:" || u.protocol === "https:") ? u.toString() : "";
      } catch {
        return "";
      }
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function popupHTML(c) {
      const name = `<h3 class="h6 mb-1 h-serif" style="font-weight: 600;">${escapeHtml(c.name)}</h3>`;
      const addr = c.address ? `<div class="small text-secondary">${escapeHtml(c.address)}</div>` : "";

      const maps = (Number.isFinite(c.lat) && Number.isFinite(c.lng))
        ? `<a class="link-primary" href="https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lng}" target="_blank" rel="noopener noreferrer">Åpne i kart</a>`
        : "";

      const siteUrl = normalizeWebsite(c.website);
      const site = siteUrl
        ? `<a class="link-primary ms-2" href="${siteUrl}" target="_blank" rel="noopener noreferrer">Nettside</a>`
        : "";

      return `<div class="vstack gap-1">${name}${addr}<div class="small">${maps}${site}</div></div>`;
    }

    function setNotice(messageNodeOrString, kind) {
      const el = $("notice");
      if (!el) return;

      el.innerHTML = "";

      if (!messageNodeOrString) {
        el.className = "mt-3 d-none";
        return;
      }

      const wrap = document.createElement("div");
      const level = kind === "error" ? "danger" : "secondary";
      wrap.className = `alert alert-${level} d-flex align-items-center gap-2 mb-0`;

      const icon = document.createElement("i");
      icon.className = kind === "error"
        ? "fa-solid fa-triangle-exclamation"
        : "fa-solid fa-circle-info";
      icon.setAttribute("aria-hidden", "true");

      const content = document.createElement("div");
      if (typeof messageNodeOrString === "string") content.textContent = messageNodeOrString;
      else content.append(messageNodeOrString);

      wrap.append(icon, content);
      el.append(wrap);
      el.className = "mt-3";
    }

    function setLoading(isLoading) {
      const loadingEl = $("loading");
      const mapEl = $("map");
      if (!loadingEl || !mapEl) return;

      loadingEl.classList.toggle("d-none", !isLoading);
      loadingEl.classList.toggle("d-flex", isLoading);
      mapEl.classList.toggle("loading-blur", isLoading);
    }

    async function fetchCsvText(url, { timeoutMs = 12000 } = {}) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.text();
      } finally {
        clearTimeout(t);
      }
    }

    function numOrNaN(v) {
      const s = String(v ?? "").trim().replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function parseRows(csvText) {
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      const rows = Array.isArray(parsed.data) ? parsed.data : [];

      const items = rows.map((r) => ({
        name: String(r.name ?? r.Navn ?? "").trim(),
        lat: numOrNaN(r.lat ?? r.latitude ?? r.Lat ?? r.Breddegrad),
        lng: numOrNaN(r.lng ?? r.longitude ?? r.Lng ?? r.Lengdegrad),
        address: String(r.address ?? r.Adresse ?? "").trim(),
        website: String(r.website ?? r.Nettside ?? "").trim()
      })).filter(c => c.name && Number.isFinite(c.lat) && Number.isFinite(c.lng));

      const seen = new Set();
      const deduped = [];
      for (const it of items) {
        const key = `${it.name}@@${it.lat.toFixed(6)},${it.lng.toFixed(6)}`;
        if (seen.has(key)) continue;
        seen.add(key);
        deduped.push(it);
      }
      return deduped;
    }

    function renderMarkers() {
      markersLayer.clearLayers();

      for (const c of CHURCHES) {
        if (!Number.isFinite(c.lat) || !Number.isFinite(c.lng)) continue;
        L.marker([c.lat, c.lng])
          .bindPopup(popupHTML(c), { autoPan: true, keepInView: true })
          .addTo(markersLayer);
      }

      setLoading(false);

      if (CHURCHES.length === 0) {
        setNotice("Ingen menigheter registrert enda.", "error");
      } else {
        setNotice("", "");
      }
    }

    async function loadChurches() {
      setLoading(true);
      setNotice("", "");

      try {
        const csvText = await fetchCsvText(CSV_URL);
        CHURCHES = parseRows(csvText);
        renderMarkers();
      } catch (err) {
        console.error("CSV load/parse error:", err);
        setLoading(false);

        const frag = document.createDocumentFragment();
        const span = document.createElement("span");
        span.textContent = "Kunne ikke hente menighetsdata.";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-secondary btn-sm ms-2";
        btn.innerHTML = '<i class="fa-solid fa-rotate-right" aria-hidden="true"></i><span class="ms-1">Prøv igjen</span>';
        btn.addEventListener("click", () => loadChurches());

        frag.append(span, btn);
        setNotice(frag, "error");
      }
    }

    function initMap() {
      const southBounds = L.latLngBounds(SOUTHERN_NORWAY_BOUNDS);
      const lockBounds  = L.latLngBounds(SOUTHERN_LOCK_BOUNDS);

      map = L.map("map", {
        maxBounds: lockBounds.pad(0.02),
        maxBoundsViscosity: 1.0,
        minZoom: 4,
        worldCopyJump: false,
        preferCanvas: true,
        zoomControl: true
      });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        detectRetina: true,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> bidragsytere'
      }).addTo(map);

      L.control.scale({ metric: true, imperial: false }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
      map.fitBounds(southBounds);
    }

    function boot() {
      if (!window.L || !window.Papa) {
        setNotice("Kartbiblioteket ble ikke lastet riktig. Oppdater siden.", "error");
        return;
      }
      initMap();
      loadChurches();
    }

    document.addEventListener("DOMContentLoaded", boot, { once: true });
  })();
</script>

</body>
</html>
