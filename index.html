<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <meta name="description" content="Finnkirke.no – et kart for å finne bibelske, protestantiske menigheter i Norge." />
  <title>Finnkirke.no – Finn bibelske menigheter i Norge</title>

  <!-- Bootstrap 5 (defer JS to avoid blocking render) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- Leaflet (deferred so it doesn't block first paint) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" />

  <!-- PapaParse (deferred so it doesn't block first paint) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
      --font-serif: 'EB Garamond', ui-serif, Georgia, Cambria, 'Times New Roman', Times, serif;
      --amber-focus: rgba(255,193,7,.55);
    }

    body {
      overscroll-behavior: none;
      font-family: var(--font-sans);
      background: #f8f9fa;
    }

    #map { height: min(62vh, 680px); }
    @media (max-width: 768px) { #map { height: 56vh; } }

    .sc { font-variant: small-caps; letter-spacing: .01em; }
    .h-serif { font-family: var(--font-serif); }
    .lead-muted { color: rgba(33,37,41,.72); }
    .p-comfy { line-height: 1.62; }

    /* Missing in original: you used .cardish but didn't define it. */
    .cardish {
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      box-shadow: 0 .5rem 1.25rem rgba(0,0,0,.08);
      background: #fff;
    }

    /* Focus visibility */
    :focus-visible {
      outline: 3px solid var(--amber-focus);
      outline-offset: 2px;
      border-radius: 10px;
    }
    .visually-hidden-focusable:focus {
      clip: auto !important;
      clip-path: none !important;
      height: auto !important;
      width: auto !important;
      white-space: normal !important;
      z-index: 10000;
    }

    .icon-badge {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(255, 193, 7, 0.12);
      border: 1px solid rgba(255, 193, 7, 0.25);
      color: #b45309;
      flex: 0 0 auto;
      margin-top: 2px;
    }

    /* Loading overlay: blur + text + glass */
    #map.loading-blur { filter: blur(2px) saturate(0.9); }
    #loading {
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      background: rgba(255,255,255,.72);
    }
    .loading-card {
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 .5rem 1.25rem rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 14px 16px;
    }
    .loading-text { font-size: .98rem; color: rgba(33,37,41,.72); }

    /* Reserve space so notice doesn’t jump layout */
    #notice { min-height: 0; }

    /* Leaflet controls: softer + coherent */
    .leaflet-bar a {
      border-radius: 12px !important;
      box-shadow: 0 .25rem .75rem rgba(0,0,0,.10);
      border: 1px solid rgba(0,0,0,.10) !important;
    }
    .leaflet-bar a:focus-visible {
      outline: 3px solid var(--amber-focus);
      outline-offset: 2px;
    }
    .leaflet-control-scale-line {
      border-radius: 10px;
      padding: 2px 6px;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 .25rem .75rem rgba(0,0,0,.08);
    }
  </style>
</head>

<body class="text-dark">
  <a href="#map" class="visually-hidden-focusable position-absolute m-2 p-2 bg-white border rounded">Hopp til kart</a>

  <header class="border-bottom bg-white">
    <div class="container-fluid py-4 py-md-5">
      <div class="mx-auto" style="max-width: 1200px;">

        <h1 class="sc mb-2 text-center h-serif"
            style="font-weight: 700; font-size: clamp(1.9rem, 3vw, 2.7rem);">
          Finnkirke.no
        </h1>

        <p class="mb-4 text-center mx-auto lead-muted"
           style="max-width: 80ch; font-size: 1.05rem;">
          Et enkelt kart som hjelper deg å finne menigheter som søker å være bibelske i tro, liv og kirkelig praksis.
        </p>

        <!-- Map -->
        <div class="mb-3">
          <div id="map"
               role="region"
               aria-label="Kart over menigheter i Sør-Norge"
               class="position-relative border rounded-4 bg-white shadow-sm overflow-hidden">

            <div id="loading"
                 class="position-absolute top-0 start-0 end-0 bottom-0 d-none align-items-center justify-content-center">
              <div class="loading-card d-flex align-items-center gap-3">
                <div class="spinner-border text-secondary" role="status" aria-label="Laster"></div>
                <div class="loading-text">
                  <div class="fw-semibold text-dark">Laster menigheter…</div>
                  <div class="small">Henter data og oppdaterer kartet.</div>
                </div>
              </div>
            </div>
          </div>

          <div id="notice" class="mt-3" aria-live="polite"></div>
        </div>

        <!-- Kriterier -->
        <div class="accordion mt-4" id="criteriaSection">
          <div class="accordion-item cardish overflow-hidden">
            <h2 class="accordion-header" id="criteriaSectionH">
              <button class="accordion-button collapsed h-serif" type="button"
                      data-bs-toggle="collapse" data-bs-target="#criteriaSectionBody"
                      aria-expanded="false" aria-controls="criteriaSectionBody">
                <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-list-check"></i></span>
                Kriterier for inkludering
                <span class="ms-auto small text-secondary">Hva som kvalifiserer en menighet til å vises på kartet</span>
              </button>
            </h2>

            <div id="criteriaSectionBody" class="accordion-collapse collapse"
                 aria-labelledby="criteriaSectionH" data-bs-parent="#criteriaSection">
              <div class="accordion-body">

                <div class="accordion" id="criteriaAccordion">

                  <!-- Protestantisk -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critOneH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critOne"
                              aria-expanded="false" aria-controls="critOne">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-book-bible"></i></span>
                        Protestantisk
                      </button>
                    </h3>
                    <div id="critOne" class="accordion-collapse collapse" aria-labelledby="critOneH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          En protestantisk forankring gir menigheten et fast og felles utgangspunkt: Guds ord, ikke skiftende tradisjoner eller personlige preferanser. Når frelsen forstås som Guds frie gave i Kristus alene, skapes det både trygghet for den enkelte og ydmykhet i fellesskapet, og hele menighetslivet rettes mot Guds ære fremfor menneskelig prestasjon.
                        </p>
                        <div class="small text-secondary fst-italic">Rom 1,16–17 · Ef 2,8–9 · Joh 14,6 · 1 Kor 10,31</div>
                      </div>
                    </div>
                  </div>

                  <!-- Familiesentrert -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critFiveH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critFive"
                              aria-expanded="false" aria-controls="critFive">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-house"></i></span>
                        Familiesentrert
                      </button>
                    </h3>
                    <div id="critFive" class="accordion-collapse collapse" aria-labelledby="critFiveH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          En familiesentrert forståelse styrker både menighet og samfunn ved å bygge nedenfra og opp. Når ekteskap, foreldreskap og generasjoner tas på alvor, skapes stabile rammer for trosoverføring, ansvar og omsorg. Menigheten blir et sted hvor familier støttes i sitt kall, og hvor fellesskapet formes av varige relasjoner.
                        </p>
                        <div class="small text-secondary fst-italic">1 Mos 2,24 · Sal 127 · Ef 6,1–4 · 2 Tim 1,5</div>
                      </div>
                    </div>
                  </div>

                  <!-- Forpliktende medlemskap -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critTwoH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critTwo"
                              aria-expanded="false" aria-controls="critTwo">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-user-group"></i></span>
                        Forpliktende medlemskap
                      </button>
                    </h3>
                    <div id="critTwo" class="accordion-collapse collapse" aria-labelledby="critTwoH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          Forpliktende medlemskap gjør menigheten til et virkelig fellesskap, ikke bare et løst nettverk av enkeltpersoner. Når mennesker binder seg til hverandre i ansvar og nærvær, skapes stabilitet, gjensidig omsorg og rom for å vokse i tro over tid. Menigheten blir da en kropp som faktisk bærer sine lemmer.
                        </p>
                        <div class="small text-secondary fst-italic">Heb 10,24–25 · Apg 2,42</div>
                      </div>
                    </div>
                  </div>

                  <!-- Bibelsk menighetsstruktur -->
                  <div class="accordion-item cardish overflow-hidden mb-3">
                    <h3 class="accordion-header" id="critThreeH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critThree"
                              aria-expanded="false" aria-controls="critThree">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-sitemap"></i></span>
                        Bibelsk menighetsstruktur
                      </button>
                    </h3>
                    <div id="critThree" class="accordion-collapse collapse" aria-labelledby="critThreeH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          En bibelsk menighetsstruktur beskytter både menigheten og lederne ved å gi klare rammer for ansvar og tjeneste. Når lederskapet består av bibelske kvalifiserte menn, fremfor pragmatiske figurer, fremmes modenhet, kontinuitet og tillit, og menigheten kan ledes med både fasthet og omsorg.
                        </p>
                        <div class="small text-secondary fst-italic">1 Tim 3,1–13 · Tit 1,5–9</div>
                      </div>
                    </div>
                  </div>

                  <!-- Kirkedisiplin -->
                  <div class="accordion-item cardish overflow-hidden mb-0">
                    <h3 class="accordion-header" id="critFourH">
                      <button class="accordion-button collapsed h-serif" type="button"
                              data-bs-toggle="collapse" data-bs-target="#critFour"
                              aria-expanded="false" aria-controls="critFour">
                        <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-gavel"></i></span>
                        Sakramental kirkedisiplin
                      </button>
                    </h3>
                    <div id="critFour" class="accordion-collapse collapse" aria-labelledby="critFourH" data-bs-parent="#criteriaAccordion">
                      <div class="accordion-body">
                        <p class="mb-3 text-secondary p-comfy">
                          Kirkedisiplin er gitt for å verne både enkeltmennesket og fellesskapet. Når alvorlig synd tas på alvor i kjærlighet og sannhet, tydeliggjøres evangeliets alvor og nåde. Dette kan, når Skriften krever det, innebære utestengelse fra nattverden, menighetens sakramentale fellesskap. Målet er alltid omvendelse og gjenopprettelse, slik at menigheten kan forbli et tydelig og troverdig vitnesbyrd.
                        </p>
                        <div class="small text-secondary fst-italic">Matt 18,15–17 · 1 Kor 5</div>
                      </div>
                    </div>
                  </div>

                </div><!-- /criteriaAccordion -->
              </div>
            </div>
          </div>
        </div><!-- /criteriaSection -->

        <!-- Meld inn / foreslå endring -->
        <div class="accordion mt-4" id="submitSection">
          <div class="accordion-item cardish overflow-hidden">
            <h2 class="accordion-header" id="submitSectionH">
              <button class="accordion-button collapsed h-serif" type="button"
                      data-bs-toggle="collapse" data-bs-target="#submitSectionBody"
                      aria-expanded="false" aria-controls="submitSectionBody">
                <span class="me-2 icon-badge" aria-hidden="true"><i class="fa-solid fa-pen-to-square"></i></span>
                Foreslå menighet eller oppdatering
                <span class="ms-auto small text-secondary">Send inn via skjema</span>
              </button>
            </h2>
            <div id="submitSectionBody" class="accordion-collapse collapse"
                 aria-labelledby="submitSectionH" data-bs-parent="#submitSection">
              <div class="accordion-body">
                <p class="mb-3 text-secondary p-comfy">
                  Har du en menighet som bør legges til, eller en opplysning som må korrigeres? Bruk skjemaet under.
                </p>
                <div class="ratio" style="--bs-aspect-ratio: 140%;">
                  <iframe
                    title="Skjema: meld inn menighet eller endring"
                    src="https://docs.google.com/forms/d/e/1FAIpQLSelRxSIeMS6iY4kXhmf5w2dAfrYh3VHGtIoLuKC8VCuqi_XOw/viewform?usp=publish-editor"
                    loading="lazy"
                    style="border:0;"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
              </div>
            </div>
          </div>
        </div><!-- /submitSection -->
      </div>
    </div>
  </header>

  <main class="py-4"></main>

  <script>
  (function () {
    "use strict";

    // =============================
    // Config
    // =============================
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1iQMv5M8hrapIbvolhIKRHOcX3yx7CPX8zQogXzwhtec/export?format=csv';

    // Sør-Norge focus + lock bounds
    const SOUTHERN_NORWAY_BOUNDS = L.latLngBounds([57.8, 3.5], [62.6, 13.6]);
    const SOUTHERN_LOCK_BOUNDS   = L.latLngBounds([57.5, 2.0], [62.9, 14.5]);

    // Simple client-side caching to reduce network hits + improve perceived performance.
    const CACHE_KEY = 'kirkekart_csv_cache_v1';
    const CACHE_TTL_MS = 10 * 60 * 1000; // 10 minutes

    // Only run assertions if user explicitly asks for it: ?debug=1
    const DEBUG = new URLSearchParams(location.search).get('debug') === '1';

    let CHURCHES = [];
    const markersLayer = L.layerGroup();

    const $ = (id) => document.getElementById(id);

    // =============================
    // Helpers
    // =============================
    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;');
    }

    function normalizeWebsite(url) {
      const raw = String(url || '').trim();
      if (!raw) return '';
      const prefixed = /^https?:\/\//i.test(raw) ? raw : 'https://' + raw;
      try {
        const u = new URL(prefixed);
        if (u.protocol === 'http:' || u.protocol === 'https:') return u.toString();
      } catch (_) {}
      return '';
    }

    // Norway-friendly number parsing: accepts "10,123" and "10.123".
    function parseNumber(x) {
      const s = String(x ?? '').trim();
      if (!s) return NaN;
      const normalized = s.replace(',', '.');
      return Number(normalized);
    }

    function popupHTML(c) {
      const name = `<h3 class="h6 mb-1 h-serif" style="font-weight: 600;">${escapeHtml(c.name)}</h3>`;
      const addr = c.address ? `<div class="small text-secondary">${escapeHtml(c.address)}</div>` : '';

      const maps = (Number.isFinite(c.lat) && Number.isFinite(c.lng))
        ? `<a class="link-primary" href="https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lng}" target="_blank" rel="noopener noreferrer">Åpne i kart</a>`
        : '';

      const siteUrl = normalizeWebsite(c.website);
      const site = siteUrl ? `<a class="link-primary ms-2" href="${siteUrl}" target="_blank" rel="noopener noreferrer">Nettside</a>` : '';

      return `<div class="vstack gap-1">${name}${addr}<div class="small">${maps}${site}</div></div>`;
    }

    function setNotice(message, kind) {
      const el = $("notice");
      if (!el) return;
      el.innerHTML = '';

      if (!message) {
        el.className = 'mt-3 d-none';
        return;
      }

      const wrap = document.createElement('div');
      const level = kind === 'error' ? 'danger' : 'secondary';
      wrap.className = `alert alert-${level} d-flex align-items-center gap-2 mb-0`;

      const icon = document.createElement('i');
      icon.className = kind === 'error' ? 'fa-solid fa-triangle-exclamation' : 'fa-solid fa-circle-info';
      icon.setAttribute('aria-hidden', 'true');

      const content = document.createElement('div');
      content.append(message);

      wrap.append(icon, content);
      el.append(wrap);
      el.className = 'mt-3';
    }

    function showLoading(on) {
      const loadingEl = $("loading");
      const mapEl = $("map");
      if (!loadingEl || !mapEl) return;
      if (on) {
        loadingEl.classList.remove('d-none');
        loadingEl.classList.add('d-flex');
        mapEl.classList.add('loading-blur');
      } else {
        loadingEl.classList.add('d-none');
        loadingEl.classList.remove('d-flex');
        mapEl.classList.remove('loading-blur');
      }
    }

    // =============================
    // Map init
    // =============================
    const map = L.map('map', {
      maxBounds: SOUTHERN_LOCK_BOUNDS.pad(0.02),
      maxBoundsViscosity: 1.0,
      minZoom: 4,
      worldCopyJump: false,
      preferCanvas: true,
      zoomControl: true,
      renderer: L.canvas()
    });

    // OSM tiles: consider hosting your own or using a provider with an API key if this gets heavy traffic.
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      detectRetina: true,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> bidragsytere'
    }).addTo(map);

    L.control.scale({ metric: true, imperial: false }).addTo(map);
    markersLayer.addTo(map);
    map.fitBounds(SOUTHERN_NORWAY_BOUNDS);

    function renderMarkers() {
      markersLayer.clearLayers();

      // Only create markers for valid coordinates.
      for (const c of CHURCHES) {
        if (!Number.isFinite(c.lat) || !Number.isFinite(c.lng)) continue;
        const marker = L.marker([c.lat, c.lng]).bindPopup(popupHTML(c), {
          autoPan: true,
          keepInView: true,
          closeButton: true
        });
        markersLayer.addLayer(marker);
      }

      showLoading(false);

      const count = CHURCHES.length;
      if (count === 0) {
        const msg = document.createElement('span');
        msg.textContent = 'Ingen menigheter registrert enda.';
        setNotice(msg, 'error');
      } else {
        setNotice('', '');
      }
    }

    // =============================
    // CSV loading (with caching)
    // =============================
    function readCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj.text !== 'string' || typeof obj.ts !== 'number') return null;
        if ((Date.now() - obj.ts) > CACHE_TTL_MS) return null;
        return obj.text;
      } catch (_) {
        return null;
      }
    }

    function writeCache(text) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), text }));
      } catch (_) {
        // ignore quota / private mode
      }
    }

    async function fetchCsvText(url, { timeoutMs = 12000 } = {}) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(url, {
          signal: ctrl.signal,
          cache: 'no-store',
          headers: { 'Accept': 'text/csv,text/plain;q=0.9,*/*;q=0.8' }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.text();
      } finally {
        clearTimeout(t);
      }
    }

    function parseRows(csvText) {
      const { data, errors } = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false
      });

      if (DEBUG && errors?.length) {
        console.warn('CSV parse warnings:', errors.slice(0, 5));
      }

      const items = (data || []).map((r) => {
        const name = (r.name || r.Navn || '').toString().trim();
        const lat = parseNumber(r.lat ?? r.latitude ?? r.Lat ?? r.Breddegrad);
        const lng = parseNumber(r.lng ?? r.longitude ?? r.Lng ?? r.Lengdegrad);
        const address = (r.address || r.Adresse || '').toString().trim();
        const website = (r.website || r.Nettside || '').toString().trim();
        return { name, lat, lng, address, website };
      }).filter(c => c.name && Number.isFinite(c.lat) && Number.isFinite(c.lng));

      // Deduplicate by name + rounded coords
      const seen = new Set();
      const deduped = [];
      for (const it of items) {
        const key = `${it.name}@@${it.lat.toFixed(6)},${it.lng.toFixed(6)}`;
        if (seen.has(key)) continue;
        seen.add(key);
        deduped.push(it);
      }
      return deduped;
    }

    async function loadChurches() {
      showLoading(true);
      setNotice('', '');

      // Try cache first (fast path)
      const cached = readCache();
      if (cached) {
        try {
          CHURCHES = parseRows(cached);
          renderMarkers();
          // Refresh in the background to keep it reasonably fresh
          fetchCsvText(CSV_URL).then((fresh) => {
            writeCache(fresh);
            const next = parseRows(fresh);
            // Only re-render if something changed.
            if (next.length !== CHURCHES.length) {
              CHURCHES = next;
              renderMarkers();
            }
          }).catch(() => {/* silent */});
          return;
        } catch (_) {
          // If cache is corrupted, fall through to network.
        }
      }

      try {
        const csvText = await fetchCsvText(CSV_URL);
        writeCache(csvText);
        CHURCHES = parseRows(csvText);
        renderMarkers();
      } catch (err) {
        if (DEBUG) console.error('CSV load/parse error:', err);
        showLoading(false);

        const frag = document.createDocumentFragment();
        const span = document.createElement('span');
        span.textContent = 'Kunne ikke hente menighetsdata. ';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-secondary btn-sm ms-2';
        btn.innerHTML = '<i class="fa-solid fa-rotate-right" aria-hidden="true"></i><span class="ms-1">Prøv igjen</span>';
        btn.addEventListener('click', () => loadChurches(), { once: true });

        frag.append(span, btn);
        setNotice(frag, 'error');
      }
    }

    // =============================
    // Optional self-tests (debug only)
    // =============================
    (function selfTests() {
      if (!DEBUG) return;
      try {
        console.assert(typeof L === 'object', 'Leaflet should be loaded');
        console.assert(typeof Papa === 'object', 'PapaParse should be loaded');
        console.assert(Array.isArray(CHURCHES), 'CHURCHES should be an array');
        const _testPopup = popupHTML({ name: 'Test', lat: 60, lng: 10, address: 'Adresse', website: 'https://eksempel.no' });
        console.assert(typeof _testPopup === 'string' && _testPopup.includes('Test'), 'popupHTML should return string with name');
      } catch (e) {
        console.warn('Self-tests failed (non-fatal):', e);
      }
    })();

    // Show the base map immediately; load churches right after.
loadChurches();
  })();
  </script>
</body>
</html>
